<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Fan Control</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/static/vendor/chart.min.js"></script>
    <style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", "Roboto", "Noto Sans", "Helvetica Neue", Arial, sans-serif;
  background-color: #f4f6f8;
  color: #222;
  margin: 0;
  padding: 20px;
  text-align: center;
}

header {
  background-color: #0077cc;
  color: white;
  padding: 1.5rem 1rem;
  text-align: center;
  margin-bottom: 1.5rem;
  border-radius: 0.5rem;
  position: relative;
}

.header-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.alarm-box {
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.postrun-box {
  font-size: 0.9rem;
  margin-top: 0.25rem;
}

  .reboot-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
  }

  .theme-toggle {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
  }

main {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

.card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  text-align: left;
  max-width: 700px;
  width: 100%;
}

.card h2 {
  margin-bottom: 1rem;
  font-size: 1.25rem;
  font-weight: 600;
  text-align: center;
}

.tabs {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.tabs button {
  padding: 0.6rem 1.2rem;
  font-weight: 600;
  border: none;
  background-color: #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s, color 0.3s;
}

.tabs button .icon {
  margin-right: 0.4rem;
}

.icon {
  display: inline-block;
  margin-right: 0.4rem;
}

.tabs button.active {
  background-color: #0077cc;
  color: white;
}

.tab-content {
  display: none;
  width: 100%;
  flex-direction: column;
  align-items: center;
}

.tab-content.active {
  display: flex;
}

label {
  display: block;
  margin: 0.75rem 0 0.3rem;
  font-weight: 600;
  font-size: 0.95rem;
}

input[type="number"], input[type="text"], select {
  width: 100%;
  padding: 0.6rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
  margin-bottom: 0.75rem;
  box-sizing: border-box;
}

button, input[type="submit"] {
  background-color: #0077cc;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.95rem;
  margin-top: 0.75rem;
  transition: background-color 0.3s;
}

button:hover, input[type="submit"]:hover {
  background-color: #005fa3;
}

.feedback {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: #0077cc;
  display: none;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
  margin-top: 0.75rem;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #0077cc;
}

input:checked + .slider:before {
  transform: translateX(22px);
}

canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 300px;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 1rem;
}

.log-table-wrapper {
  max-height: 300px;
  overflow-y: auto;
  overflow-x: auto;
}

.log-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

.log-table th,
.log-table td {
  padding: 0.25rem 0.5rem;
  border-bottom: 1px solid #ddd;
  text-align: left;
}

.log-table thead th {
  position: sticky;
  top: 0;
  background: #fafafa;
  z-index: 1;
}

.log-table td.log-message {
  font-family: 'Courier New', monospace;
  white-space: pre;
  max-width: 240px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.log-table tr.log-info { background-color: #e8f4fd; color: #0c5460; }
.log-table tr.log-warn { background-color: #fff4e5; color: #664d03; }
.log-table tr.log-error { background-color: #fdecea; color: #842029; }
.log-table tr.log-success { background-color: #e6f4ea; color: #0f5132; }

.log-table td:nth-child(5),
.log-table td:nth-child(6),
.log-table td:nth-child(8),
.log-table td:nth-child(9),
.log-table td:nth-child(10) {
  text-align: right;
}

body.dark-mode {
  background-color: #1e1e1e;
  color: #eee;
}
body.dark-mode header {
  background-color: #005fa3;
}
body.dark-mode .card {
  background: #2a2a2a;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
body.dark-mode .tabs button {
  background-color: #444;
  color: #eee;
}
body.dark-mode .tabs button.active {
  background-color: #005fa3;
}
body.dark-mode input[type="number"],
body.dark-mode input[type="text"],
body.dark-mode select {
  background-color: #333;
  border: 1px solid #555;
  color: #eee;
}
body.dark-mode button,
body.dark-mode input[type="submit"] {
  background-color: #005fa3;
}
body.dark-mode button:hover,
body.dark-mode input[type="submit"]:hover {
  background-color: #00467a;
}
body.dark-mode .log-table th,
body.dark-mode .log-table td {
  border-bottom: 1px solid #555;
}
body.dark-mode .log-table thead th {
  background: #333;
}
body.dark-mode .log-table-wrapper {
  background: #2a2a2a;
}
body.dark-mode .log-table tr.log-info { background-color: #055160; color: #cff4fc; }
body.dark-mode .log-table tr.log-warn { background-color: #664d03; color: #fff3cd; }
body.dark-mode .log-table tr.log-error { background-color: #842029; color: #f8d7da; }
body.dark-mode .log-table tr.log-success { background-color: #0f5132; color: #d1e7dd; }
    </style>
</head>
<body>
<header id="main-header">
  <label class="switch theme-toggle">
    <input type="checkbox" id="darkModeToggle">
    <span class="slider"></span>
  </label>
  <div class="header-container">
    <h1><span class="icon" aria-hidden="true">ğŸŒ€</span>Sperrluft Steuerung</h1>
    <div id="alarmIndicator" class="alarm-box safe">
      <span class="icon">ğŸŸ¢</span> Kein Alarm
    </div>
    <div id="postrunCountdown" class="postrun-box" style="display:none;">
      Nachlauf aktiv: <span id="postrunSeconds"></span> s
    </div>
  </div>
  <button id="rebootButton" class="reboot-btn" title="Neustart">ğŸ”„ Neustart</button>
</header>

<main>
  <div class="card">
    <h2><span class="icon" aria-hidden="true">ğŸ“ˆ</span>Temperatur &amp; Output</h2>
    <canvas id="tempChart" width="400" height="200"></canvas>
  </div>

  <div class="tabs">
    <button class="tab-button active" data-tab="statusTab">
      <span class="icon" aria-hidden="true">â„¹ï¸</span>Status
    </button>
    <button class="tab-button" data-tab="settingsTab">
      <span class="icon" aria-hidden="true">ğŸ›ï¸</span>Einstellungen
    </button>
    <button class="tab-button" data-tab="logTab">
      <span class="icon" aria-hidden="true">ğŸ“„</span>Log
    </button>
  </div>
</main>

<div id="statusTab" class="tab-content active">
  <div class="card">
    <h2><span class="icon" aria-hidden="true">â„¹ï¸</span>Status</h2>
    <div class="value"><span class="icon" aria-hidden="true">ğŸŒ¡ï¸</span>Temperature 1 (<span id="temp1Pin">--</span>): <span id="temp1">--</span> Â°C</div>
    <div class="value" id="temp1Status">&nbsp;</div>
    <div class="value"><span class="icon" aria-hidden="true">ğŸŒ¡ï¸</span>Temperature 2 (<span id="temp2Pin">--</span>): <span id="temp2">--</span> Â°C</div>
    <div class="value" id="temp2Status">&nbsp;</div>
    <div class="value"><span class="icon" aria-hidden="true">ğŸ“Ÿ</span>Output: <span id="output">--</span> %</div>
    <div class="value"><span class="icon" aria-hidden="true">âš™ï¸</span>Mode: <span id="mode">--</span></div>
    <div class="value"><span class="icon" aria-hidden="true">ğŸ¯</span>Solltemperatur: <span id="setpoint">--</span> Â°C</div>
    <div class="value"><span class="icon" aria-hidden="true">âš ï¸</span>Alarmgrenze: <span id="alarmThreshold">--</span> Â°C</div>
    <div class="value"><span class="icon" aria-hidden="true">ğŸŒ¡ï¸</span>Thermoelement-Typ: <span id="tcTypeStatus">--</span></div>

    <hr style="margin: 1.5rem 0;">

    <label for="modeToggle"><span class="icon" aria-hidden="true">âœ‹</span>Manueller Modus</label>
    <label class="switch">
      <input type="checkbox" id="modeToggle">
      <span class="slider"></span>
    </label>

    <form id="manualOutputForm" style="display: none;">
      <label for="manualOutputInput"><span class="icon" aria-hidden="true">ğŸ“Ÿ</span>Manueller Output</label>
      <input type="number" step="1" min="0" max="100" id="manualOutputInput" placeholder="">
      <input type="submit" value="Senden">
      <div class="feedback" id="manualFeedback">âœ”ï¸ Output gesendet</div>
    </form>
  </div>
</div>

<div id="settingsTab" class="tab-content">
  <div class="card">
    <h2><span class="icon" aria-hidden="true">ğŸ›ï¸</span>Einstellungen</h2>
    <form id="setpointForm">
      <label for="setpointInput"><span class="icon" aria-hidden="true">ğŸ¯</span>Solltemperatur</label>
      <input type="number" step="0.1" id="setpointInput" placeholder="">
      <input type="submit" value="Senden">
      <div class="feedback" id="setpointFeedback">âœ”ï¸ Sollwert gesendet</div>
    </form>
    <form id="alarmForm">
      <label for="alarmInput"><span class="icon" aria-hidden="true">âš ï¸</span>Alarmgrenze</label>
      <input type="number" step="0.1" id="alarmInput" placeholder="">
      <input type="submit" value="Senden">
      <div class="feedback" id="alarmFeedback">âœ”ï¸ Alarmgrenze gesendet</div>
    </form>
    <form id="alarmOutputForm">
      <label for="alarmOutputInput"><span class="icon" aria-hidden="true">âš¡</span>Output im Alarmmodus (%)</label>
      <input type="number" step="1" min="0" max="100" id="alarmOutputInput">
      <input type="submit" value="Senden">
      <div class="feedback" id="alarmPwmFeedback">âœ”ï¸ Alarm-Output gesendet</div>
    </form>
    <form id="minOutputForm">
      <label for="minOutputInput"><span class="icon" aria-hidden="true">ğŸ“Ÿ</span>Minimaler Output (Wiper)</label>
      <input type="number" step="1" min="0" max="127" id="minOutputInput">
      <input type="submit" value="Senden">
      <div class="feedback" id="minOutputFeedback">âœ”ï¸ Minimaler Output gesendet</div>
    </form>
    <form id="postrunForm">
      <label for="postrunInput"><span class="icon" aria-hidden="true">â±ï¸</span>Nachlaufzeit (s)</label>
      <input type="number" step="1" min="0" id="postrunInput" placeholder="">
      <input type="submit" value="Senden">
      <div class="feedback" id="postrunFeedback">âœ”ï¸ Nachlaufzeit gesendet</div>
    </form>

    <hr style="margin: 1.5rem 0;">

    <label for="tcTypeSelect"><span class="icon" aria-hidden="true">ğŸŒ¡ï¸</span>Thermoelement-Typ</label>
    <select id="tcTypeSelect">
      <option value="K">Typ K</option>
      <option value="S">Typ S</option>
    </select>
    <div class="feedback" id="tcTypeFeedback">âœ”ï¸ Thermoelement-Typ gesetzt</div>

    <label for="swapToggle"><span class="icon" aria-hidden="true">ğŸ”</span>Sensorrollen tauschen</label>
    <label class="switch">
      <input type="checkbox" id="swapToggle">
      <span class="slider"></span>
    </label>
    <div class="value">Temperature 1: <span id="temp1PinSetting">--</span></div>
    <div class="value">Temperature 2: <span id="temp2PinSetting">--</span></div>
  </div>

  <div class="card">
    <h2><span class="icon" aria-hidden="true">ğŸ› ï¸</span>PID-Werte</h2>
    <form id="pidForm">
      <label for="kpInput">Kp</label>
      <input type="number" step="0.01" id="kpInput" placeholder="">
      <label for="kiInput">Ki</label>
      <input type="number" step="0.01" id="kiInput" placeholder="">
      <label for="kdInput">Kd</label>
      <input type="number" step="0.01" id="kdInput" placeholder="">
      <input type="submit" value="Senden">
      <div class="feedback" id="pidFeedback">âœ”ï¸ PID-Werte gesendet</div>
    </form>
  </div>
</div>

<div id="logTab" class="tab-content">
  <div class="card">
    <h2><span class="icon" aria-hidden="true">ğŸ“„</span>Log</h2>
    <button id="scanBtn">IÂ²C neu scannen</button>
    <button id="testBtn">Testmessung</button>
    <div class="log-table-wrapper" id="logWrapper">
      <table class="log-table">
        <thead>
          <tr>
            <th>Zeit</th><th>Level</th><th>Logger</th><th>Adresse</th><th>Attempt</th><th>ms</th><th>Status</th><th>Hot</th><th>Cold</th><th>Delta</th><th>Message</th>
          </tr>
        </thead>
        <tbody id="logContainer"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(button.dataset.tab).classList.add('active');
      if (button.dataset.tab === 'logTab') {
        socket.emit('request_logs');
      }
    });
  });
</script>

<script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
